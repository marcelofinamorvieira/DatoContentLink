<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>DatoCMS Visual Editing – Plain JS Demo</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      body {
        font-family: system-ui, sans-serif;
        max-width: 640px;
        margin: 2rem auto;
        line-height: 1.55;
      }

      .card {
        border: 1px solid rgba(0, 0, 0, 0.08);
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        background: #fff;
      }
    </style>
  </head>
  <body>
    <h1>DatoCMS Visual Editing (Plain JS)</h1>
    <p>
      Enable overlays by calling <code>enableDatoVisualEditing</code> after your page renders with
      stega content from DatoCMS. This demo assumes you fetched content with the required visual
      editing headers.
    </p>

    <button id="toggle-overlays" type="button">Disable visual editing</button>

    <article class="card" data-datocms-edit-target>
      <h2 id="hero-title">Loading…</h2>
      <p id="hero-copy">Fetching from DatoCMS Content Delivery API…</p>
      <img id="hero-image" alt="" style="max-width: 100%; border-radius: 6px;" />
    </article>

    <script type="module">
      import { enableDatoVisualEditing } from 'datocms-visual-editing';

      const API_TOKEN = import.meta.env?.VITE_DATO_PREVIEW_TOKEN;
      const BASE_EDITING_URL = 'https://YOURPROJECT.admin.datocms.com';
      const NORMALIZED_BASE_EDITING_URL = normalizeBaseEditingUrl(BASE_EDITING_URL);

      async function loadContent() {
        const response = await fetch('https://graphql.datocms.com/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            Authorization: `Bearer ${API_TOKEN}`,
            'X-Visual-Editing': 'vercel-v1',
            'X-Base-Editing-Url': NORMALIZED_BASE_EDITING_URL
          },
          body: JSON.stringify({
            query: `{
              hero {
                title
                copy
                image {
                  url
                  alt
                }
              }
            }`
          })
        });

        const { data } = await response.json();
        const hero = data.hero;

        document.getElementById('hero-title').textContent = hero.title;
        document.getElementById('hero-copy').textContent = hero.copy;
        const img = document.getElementById('hero-image');
        img.src = hero.image.url;
        img.alt = hero.image.alt;
      }

      loadContent().catch((error) => {
        console.error('Failed to load DatoCMS content', error);
      });

      const controller = enableDatoVisualEditing({});

      function normalizeBaseEditingUrl(url) {
        const trimmed = url.trim();
        const sanitized = trimmed.endsWith('/') ? trimmed.slice(0, -1) : trimmed;
        const parsed = new URL(sanitized);
        return `${parsed.origin}${parsed.pathname.replace(/\/$/, '')}`;
      }

      const toggleButton = document.getElementById('toggle-overlays');
      if (toggleButton) {
        toggleButton.addEventListener('click', () => {
          controller.toggle();
          toggleButton.textContent = controller.isEnabled()
            ? 'Disable visual editing'
            : 'Enable visual editing';
        });
      }
    </script>
  </body>
</html>
